name: CI - nop-provisioner

on:
  push:
    branches:
    - '**'
    - '!dependabot/**'
  pull_request: {}

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
    - name: Set up Golang
      uses: actions/setup-go@v1
      with:
        go-version: '1.13'
    # TODO remove after https://github.com/actions/setup-go/issues/14
    - name: Add GOPATH/bin to PATH
      shell: bash
      run: |
        echo "##[set-env name=GOPATH;]$(go env GOPATH)"
        echo "##[add-path]$(go env GOPATH)/bin"
      working-directory: nop-provisioner
      shell: bash
    - name: Install ko
      run: GO111MODULE=on go get github.com/google/ko/cmd/ko
      working-directory: nop-provisioner
      shell: bash
    - name: Check out code
      uses: actions/checkout@v2
    - name: Run tests
      shell: bash
      run: make build test
      working-directory: nop-provisioner
      shell: bash
    - name: Build using ko
      run: ko publish -L github.com/projectriff/riff/nop-provisioner/cmd/provisioner
      working-directory: nop-provisioner
      shell: bash
    - name: Publish
      if: |
        github.event_name == 'push' && startsWith(github.repository, 'projectriff/') && (
          github.ref == 'refs/heads/master' || (
            startsWith(github.ref, 'refs/heads/v') && endsWith(github.ref, 'x')
          )
        )
      run: .github/workflows/ci-nop-provisioner/publish.sh
      working-directory: nop-provisioner
      shell: bash
      env:
        GCLOUD_CLIENT_SECRET: ${{ secrets.GCLOUD_CLIENT_SECRET }}
